<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Gas Finder & Route Optimization - Step 5</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* Custom styles for Leaflet map display */
        #map {
            height: 100vh;
            width: 100%;
            z-index: 1; /* Keep map layer below UI */
        }
        .custom-div-icon {
            background: none !important; /* Ensure the marker background is transparent */
            border: none !important;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Leaflet Map Container -->
    <div id="map" class="shadow-xl"></div>

    <!-- Floating Control Panel with Location Input -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 w-11/12 max-w-xl z-10">
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-2xl border-t-4 border-emerald-500">
            <h1 class="text-2xl font-extrabold text-gray-800 mb-2">Local Gas Price Finder</h1>
            <p class="text-sm text-gray-500 mb-4">Enter a location or use your current coordinates to find the best fuel prices nearby.</p>

            <div id="location-input-form" class="flex flex-col sm:flex-row gap-2">
                <input
                    type="text"
                    id="location-text"
                    placeholder="Enter city, address, or zip code (e.g., San Francisco)"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 text-gray-700"
                >
                <button
                    id="find-gas-btn"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg sm:w-auto disabled:opacity-50"
                >
                    Find Gas
                </button>
            </div>

            <button
                id="use-current-location-btn"
                class="mt-3 w-full bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 rounded-lg transition duration-150 ease-in-out disabled:opacity-50"
            >
                Use Current Location (GPS)
            </button>

            <div id="status-message" class="mt-4 text-center text-sm text-gray-600 hidden"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // --- Configuration and Initialization ---
        let map;
        let userMarker;
        let userLocation = { lat: 37.7749, lon: -122.4194 }; // Stores current/default location
        const apiKey = ""; // API Key for LLM Geocoding

        const statusMessage = document.getElementById('status-message');
        const findGasBtn = document.getElementById('find-gas-btn');
        const locationInput = document.getElementById('location-text');
        const useCurrentLocationBtn = document.getElementById('use-current-location-btn');

        // Default to a known location (San Francisco)
        const DEFAULT_LAT = 37.7749;
        const DEFAULT_LON = -122.4194;
        const DEFAULT_ZOOM = 13;
        
        // --- Utility Functions ---

        // Function for exponential backoff for API calls
        async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 && i < retries - 1) {
                        // Too Many Requests, retry with delay
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                        continue;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                } catch (error) {
                    if (i === retries - 1) throw error;
                    // Network error, retry with delay
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }


        function setStatus(type, message) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'text-red-600', 'text-green-600', 'text-yellow-600', 'bg-red-100', 'bg-green-100', 'bg-yellow-100');
            const isDisabled = type === "loading";

            findGasBtn.disabled = isDisabled;
            useCurrentLocationBtn.disabled = isDisabled;

            if (type === "loading") {
                statusMessage.classList.add('text-yellow-800', 'bg-yellow-100');
            } else if (type === "error") {
                statusMessage.classList.add('text-red-800', 'bg-red-100');
            } else if (type === "success") {
                statusMessage.classList.add('text-green-800', 'bg-green-100');
            }

            if (type !== 'hidden') {
                statusMessage.classList.remove('hidden');
            }
        }

        // --- Map Functions ---

        function initializeMap(lat, lon, zoom = DEFAULT_ZOOM) {
            if (map) {
                map.remove(); // Remove existing map if re-initializing
            }
            map = L.map('map').setView([lat, lon], zoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add initial user marker
            userMarker = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="background-color: #3b82f6; width: 1.5rem; height: 1.5rem; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 2px #3b82f6;"></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(map)
              .bindPopup("<b>Current Location</b>").openPopup();
            
            userLocation = { lat, lon }; // Update the stored location
        }
        
        function updateMapLocation(lat, lon, locationName = 'Your Location') {
            map.setView([lat, lon], 14);
            userMarker.setLatLng([lat, lon]);
            userMarker.bindPopup(`<b>${locationName}</b>`).openPopup();
            userLocation = { lat, lon }; // Update the stored location
        }

        // --- Geocoding Logic (LLM API Call) ---

        async function fetchGeocode(address) {
            const systemPrompt = "You are a geocoding service. Your sole task is to take a location query and return the latitude and longitude of the primary result in JSON format. Do not include any text outside of the JSON block.";
            const userQuery = `Find the latitude and longitude for the location: ${address}`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "latitude": { "type": "NUMBER", description: "The latitude in decimal format." },
                            "longitude": { "type": "NUMBER", description: "The longitude in decimal format." }
                        },
                        required: ["latitude", "longitude"]
                    }
                }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonString);
                    if (typeof parsedJson.latitude === 'number' && typeof parsedJson.longitude === 'number') {
                        return { lat: parsedJson.latitude, lon: parsedJson.longitude };
                    }
                }
                throw new Error("Geocoding failed to return valid coordinates.");

            } catch (error) {
                console.error("Geocoding Error:", error);
                setStatus("error", `Could not find coordinates for "${address}". Please try a different location.`);
                return null;
            }
        }
        
        // --- Geolocation (GPS) Logic ---

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                setStatus("error", "Geolocation is not supported by your browser.");
                return;
            }

            setStatus("loading", "Attempting to retrieve your current GPS location...");
            
            // Standard Geolocation API call
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    updateMapLocation(lat, lon, 'Your Current GPS Location');
                    
                    // TODO: Step 6 will call the gas station finding logic here
                    setStatus("success", "Found your current location. (Next: Find nearest gas stations)");
                },
                (error) => {
                    let message;
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            message = "Location permission denied by user. Please enter a location manually.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = "Location information is unavailable.";
                            break;
                        case error.TIMEOUT:
                            message = "The request to get user location timed out.";
                            break;
                        default:
                            message = "An unknown error occurred while trying to get location.";
                            break;
                    }
                    setStatus("error", message);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }


        // --- Event Listeners ---

        findGasBtn.addEventListener('click', async () => {
            const locationText = locationInput.value.trim();
            if (!locationText) {
                 setStatus("error", "Please enter a location before searching.");
                 return;
            }

            setStatus("loading", `Searching for coordinates for "${locationText}"...`);
            
            const coordinates = await fetchGeocode(locationText);

            if (coordinates) {
                updateMapLocation(coordinates.lat, coordinates.lon, locationText);
                // TODO: Step 6 will call the gas station finding logic here
                setStatus("success", `Map centered on ${locationText}. (Next: Find nearest gas stations)`);
            }
        });

        // Use GPS
        useCurrentLocationBtn.addEventListener('click', getCurrentLocation);

        // Initialize map on load with default location
        window.onload = () => {
             initializeMap(DEFAULT_LAT, DEFAULT_LON);
             setStatus("success", "Map is ready! Enter a location above or use GPS.");
        }
    </script>
</body>
</html>